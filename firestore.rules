rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Grant public read access to any document with a 'privacy' field set to 'public'.
    allow read: if resource.data.privacy == 'public';

    // Grant public read access to the 'users' collection for leaderboards,
    // but restrict writes to the user who owns the document.
    match /users/{userId} {
      // Allow authenticated users to read the list of users for leaderboards.
      allow list: if request.auth != null;
      
      // Allow users to read their own profile, create a new one, 
      // and update their own data.
      allow read, update: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null;

      // Rules for the 'chats' subcollection.
      // Allow a user to manage their own chat sessions.
      match /chats/{chatId} {
        allow read, create, delete: if request.auth != null && request.auth.uid == userId;

        // Rules for the 'messages' sub-subcollection.
        // Allow a user to read, create, and delete messages within their own chat session.
        match /messages/{messageId} {
          allow read, create, delete: if request.auth != null && request.auth.uid == userId;
        }
      }

      // Rules for the 'quizHistory' subcollection.
      // Allow a user to read and create their own quiz attempts.
      match /quizHistory/{quizId} {
        allow read, create: if request.auth != null && request.auth.uid == userId;
      }
    }
  }
}
